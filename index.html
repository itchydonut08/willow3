<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Willow 3</title>
<style>
:root {
  --bg: #fafafa;
  --fg: #222;
  --line: #ddd;
  --pane: #fff;
  --btn-bg: #f8f8f8;
  --btn-fg: #222;
}
:root[data-theme="dark"] {
  --bg: #181818;
  --fg: #eee;
  --line: #444;
  --pane: #222;
  --btn-bg: #333;
  --btn-fg: #eee;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--fg);
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 16px;
  border-bottom: 1px solid var(--line);
}
header h1 { font-size: 18px; margin: 0; }
header .actions { display: flex; gap: 6px; }
button {
  border: 1px solid var(--line);
  background: var(--btn-bg);
  color: var(--btn-fg);
  border-radius: 8px;
  padding: 4px 10px;
  cursor: pointer;
}
.wrap { display: flex; height: calc(100vh - 50px); }
.sidebar {
  width: 260px;
  border-right: 1px solid var(--line);
  padding: 8px;
  overflow-y: auto;
  background: var(--pane);
}
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
}
#graphPane {
  flex: 1;
  position: relative;
  background: var(--pane);
}
canvas#gcanvas {
  width: 100%;
  height: 100%;
  display: block;
}
.dark-toggle {
  font-size: 18px;
  background: none;
  border: none;
}
</style>
</head>
<body>
<header>
  <h1>Willow 3</h1>
  <div class="actions">
    <button id="btn-import">Import</button>
    <button id="btn-export">Export</button>
    <button id="btn-dark" class="dark-toggle">ðŸŒ“</button>
  </div>
</header>
<div class="wrap">
  <aside class="sidebar">
    <h3>Library</h3>
    <div id="library"></div>
  </aside>
  <main class="main">
    <div id="graphPane">
      <canvas id="gcanvas"></canvas>
    </div>
  </main>
</div>

<script>
// ========= Helpers =========
const $ = sel => document.querySelector(sel);

// ========= State =========
const st = {
  notes: [],
  focusId: null
};

// ========= Dark Mode =========
function setTheme(t) {
  document.documentElement.setAttribute("data-theme", t);
  localStorage.setItem("theme", t);
}
$("#btn-dark").addEventListener("click", () => {
  const cur = document.documentElement.getAttribute("data-theme") || "light";
  setTheme(cur === "light" ? "dark" : "light");
});
const savedTheme = localStorage.getItem("theme");
if (savedTheme) setTheme(savedTheme);
else if (window.matchMedia("(prefers-color-scheme: dark)").matches) setTheme("dark");

// ========= Import / Export =========
$("#btn-export").addEventListener("click", () => {
  const data = JSON.stringify({notes: st.notes}, null, 2);
  const url = URL.createObjectURL(new Blob([data], {type:"application/json"}));
  const a = document.createElement("a");
  a.href = url; a.download = "willow_export.json"; a.click();
  URL.revokeObjectURL(url);
});
$("#btn-import").addEventListener("click", () => {
  const inp = document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange = async e => {
    const f = e.target.files[0]; if (!f) return;
    const txt = await f.text();
    const data = JSON.parse(txt);
    st.notes = data.notes || [];
    renderLibrary(); initPhysics();
  };
  inp.click();
});

// ========= Library =========
function renderLibrary(){
  const div=$("#library");
  div.innerHTML="";
  st.notes
    .slice()
    .sort((a,b)=>(b.updated_at||"").localeCompare(a.updated_at||""))
    .forEach(n=>{
      const d=document.createElement("div");
      d.textContent=n.title||"(untitled)";
      d.style.cursor="pointer";
      d.onclick=()=>{ st.focusId=n.id; initPhysics(); };
      div.appendChild(d);
    });
}

// ========= Graph Physics =========
let sim=null, nodes=[], links=[];
const g={G:60,pad:6,linkBase:110,simW:1.0,focusPull:0.65};
const canvas=$("#gcanvas"), ctx=canvas.getContext("2d");
let transform={k:1,x:0,y:0};

// Build graph data
function dataForPhysics(){
  // trivial: connect all notes randomly for demo
  const nodeList=st.notes.map((n,i)=>({
    id:n.id,title:n.title||"(untitled)",
    r:10+Math.random()*5,
    mass:1+Math.random()*2
  }));
  const linkList=[];
  for(let i=0;i<nodeList.length;i++){
    for(let j=i+1;j<nodeList.length;j++){
      if(Math.random()<0.05) linkList.push({source:nodeList[i],target:nodeList[j],sim:Math.random()});
    }
  }
  return {nodeList,linkList};
}

function resizeCanvas(){
  const rect=canvas.parentElement.getBoundingClientRect();
  canvas.width=rect.width*window.devicePixelRatio;
  canvas.height=rect.height*window.devicePixelRatio;
  ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
}
window.addEventListener("resize",resizeCanvas);

function draw(){
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.translate(transform.x,transform.y);
  ctx.scale(transform.k,transform.k);

  // links
  ctx.strokeStyle="#888"; ctx.lineWidth=1/transform.k;
  links.forEach(l=>{
    ctx.beginPath(); ctx.moveTo(l.source.x,l.source.y);
    ctx.lineTo(l.target.x,l.target.y); ctx.stroke();
  });

  // nodes
  nodes.forEach(n=>{
    ctx.beginPath();
    ctx.fillStyle=(st.focusId===n.id)?"#e33":"#39f";
    ctx.arc(n.x,n.y,n.r,0,2*Math.PI);
    ctx.fill();
  });

  ctx.restore();
}

function initPhysics(){
  const {nodeList,linkList}=dataForPhysics();
  nodes=nodeList; links=linkList;
  resizeCanvas();
  if(sim) sim.stop();

  sim=d3.forceSimulation(nodes)
    .force("link", d3.forceLink(links).id(d=>d.id).distance(l=>g.linkBase*(1-l.sim)))
    .force("charge", d3.forceManyBody().strength(d=>-30*d.mass))
    .force("collide", d3.forceCollide().radius(d=>d.r+g.pad))
    .force("center", d3.forceCenter(0,0))
    .alpha(0.9)
    .on("tick",draw);
}

// ========= Demo Data =========
st.notes=[...Array(20)].map((_,i)=>({
  id:"n"+i,title:"Note "+i,
  updated_at:new Date().toISOString()
}));
renderLibrary();
initPhysics();
</script>
<!-- d3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>
</body>
</html>
