<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Willow 1 â€” Cybernetic Workflow (POC)</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Cytoscape for graph view -->
  <script src="https://unpkg.com/cytoscape@3.30.3/dist/cytoscape.min.js"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='50' font-size='48'%3E%F0%9F%8C%B2%3C/text%3E%3C/svg%3E">
  <style>
    /* minimal extras */
    .btn { @apply px-3 py-2 rounded-xl shadow hover:shadow-md transition; }
    .card { @apply bg-white/80 backdrop-blur border border-gray-200 rounded-2xl p-4 shadow-sm; }
    .pill { @apply text-xs px-2 py-1 rounded-full bg-gray-100 border; }
    .tab { @apply cursor-pointer px-3 py-2 rounded-xl; }
    .tab-active { @apply bg-black text-white; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-2xl">ðŸŒ²</div>
        <div>
          <h1 class="text-2xl font-bold">Willow 1</h1>
          <p class="text-sm text-slate-500">Cybernetic workflow for systemic risk monitoring â€” POC</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-export" class="btn bg-white">Export Data</button>
        <label class="btn bg-white cursor-pointer">
          <input type="file" id="file-import" class="hidden" accept="application/json"/>
          Import Data
        </label>
        <button id="btn-reset" class="btn bg-white">Reset</button>
        <a href="#/agents" class="btn bg-black text-white">Agents & Settings</a>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="mt-6 flex flex-wrap gap-2">
      <a class="tab tab-active" data-tab="#/notetaker">Notetaker</a>
      <a class="tab" data-tab="#/forecast">Forecast</a>
      <a class="tab" data-tab="#/graph">Graph</a>
      <a class="tab" data-tab="#/scenarios">Scenarios</a>
      <a class="tab" data-tab="#/agents">Agents</a>
    </nav>

    <!-- Views -->
    <main class="mt-6 space-y-6">
      <!-- Notetaker -->
      <section id="view-notetaker" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Editor -->
        <div class="card">
          <h2 class="font-semibold mb-3">New Atomic Note</h2>
          <div class="grid grid-cols-1 gap-3">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <label class="text-sm">
                <div class="text-slate-600">Zettelkasten ID</div>
                <input id="note-zid" class="w-full border rounded-xl px-3 py-2" placeholder="e.g., 1.2.3"/>
              </label>
              <label class="text-sm md:col-span-2">
                <div class="text-slate-600">Title</div>
                <input id="note-title" class="w-full border rounded-xl px-3 py-2" placeholder="Short descriptive title"/>
              </label>
            </div>
            <label class="text-sm">
              <div class="text-slate-600">Content (â‰¤ 500 words)</div>
              <textarea id="note-content" rows="8" class="w-full border rounded-xl px-3 py-2" placeholder="One idea, in your own wordsâ€¦"></textarea>
            </label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <label class="text-sm">
                <div class="text-slate-600">Tags (comma separated)</div>
                <input id="note-tags" class="w-full border rounded-xl px-3 py-2" placeholder="banking, liquidity, CRE"/>
              </label>
              <label class="text-sm">
                <div class="text-slate-600">Source info (URL or citation)</div>
                <input id="note-source" class="w-full border rounded-xl px-3 py-2" placeholder="FT article, Apr 2025"/>
              </label>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button id="btn-save-draft" class="btn bg-white">Save Draft</button>
              <button id="btn-publish-note" class="btn bg-black text-white">Publish</button>
            </div>
          </div>
        </div>
        <!-- Agents -->
        <div class="card">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold mb-3">AI Agent Panel</h2>
            <button id="btn-generate-suggestions" class="btn bg-black text-white">Generate Suggestions</button>
          </div>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <label class="flex items-center gap-2"><input type="checkbox" class="agent-toggle" value="interconnectedness" checked/> Interconnectedness</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="agent-toggle" value="historian"/> Historian</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="agent-toggle" value="blind_spot" checked/> Blind Spot</label>
            <label class="flex items-center gap-2"><input type="checkbox" class="agent-toggle" value="economist"/> Economist</label>
          </div>
          <div id="agent-suggestions" class="mt-4 space-y-3"></div>
        </div>

        <!-- Recent Notes -->
        <div class="lg:col-span-2 card">
          <div class="flex items-center justify-between">
            <h3 class="font-medium">Recent Notes</h3>
            <div class="flex items-center gap-2">
              <input id="search-notes" class="border rounded-xl px-3 py-2 w-60" placeholder="Search title/tagsâ€¦"/>
              <button id="btn-new-from-suggestion" class="btn bg-white">New from Selected Suggestion</button>
            </div>
          </div>
          <div id="notes-list" class="mt-3 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
        </div>
      </section>

      <!-- Forecast -->
      <section id="view-forecast" class="hidden">
        <div class="card">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Monthly Forecast Tournament</h2>
            <button id="btn-add-question" class="btn bg-white">Add Question</button>
          </div>
          <div id="forecast-questions" class="mt-4 space-y-4"></div>
        </div>
      </section>

      <!-- Graph -->
      <section id="view-graph" class="hidden">
        <div class="card">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Knowledge Graph</h2>
            <div class="flex items-center gap-2">
              <select id="graph-filter-tag" class="border rounded-xl px-3 py-2">
                <option value="">Filter by tagâ€¦</option>
              </select>
              <button id="btn-generate-insights" class="btn bg-white">Generate Insights</button>
            </div>
          </div>
          <div id="cy" class="mt-4 border rounded-2xl" style="height: 480px;"></div>
          <div id="graph-insights" class="mt-4 text-sm"></div>
        </div>
      </section>

      <!-- Scenarios -->
      <section id="view-scenarios" class="hidden">
        <div class="card">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Scenarios (6â€“12 months)</h2>
            <button id="btn-add-scenario" class="btn bg-white">Add Scenario</button>
          </div>
          <div id="scenario-list" class="mt-4 space-y-3"></div>
        </div>
      </section>

      <!-- Agents & Settings -->
      <section id="view-agents" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="card">
            <h2 class="font-semibold mb-2">Agent Roster</h2>
            <p class="text-sm text-slate-600 mb-4">Toggle which agents auto-run after you publish a note. In offline mode, agents use rule-based heuristics. You can also add your own custom prompt.</p>
            <div id="agent-roster" class="space-y-3"></div>
            <button id="btn-add-agent" class="btn bg-white mt-2">Add Custom Agent</button>
          </div>
          <div class="card">
            <h2 class="font-semibold mb-2">LLM Integration (Optional)</h2>
            <p class="text-sm text-slate-600">Client-side keys are visible in the browser. For public demos, <strong>leave this blank</strong> to use Offline Mode.</p>
            <div class="grid grid-cols-1 gap-3">
              <label class="text-sm">
                <div class="text-slate-600">API Base URL</div>
                <input id="api-base" class="w-full border rounded-xl px-3 py-2" placeholder="e.g., https://openrouter.ai/api/v1"/>
              </label>
              <label class="text-sm">
                <div class="text-slate-600">API Key</div>
                <input id="api-key" class="w-full border rounded-xl px-3 py-2" placeholder="sk-*** (optional)"/>
              </label>
              <label class="text-sm">
                <div class="text-slate-600">Model</div>
                <input id="api-model" class="w-full border rounded-xl px-3 py-2" placeholder="e.g., openrouter/auto"/>
              </label>
              <button id="btn-save-api" class="btn bg-black text-white">Save</button>
              <div id="api-status" class="text-sm text-slate-600"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-10 text-center text-xs text-slate-500">
      Built for the Willow PRD POC. Local-first; no server required. Â© 2025
    </footer>
  </div>

<script>
/* ------------------------------
   Simple state & helpers
--------------------------------*/
const state = {
  notes: JSON.parse(localStorage.getItem('w_notes') || '[]'),
  drafts: JSON.parse(localStorage.getItem('w_drafts') || '[]'),
  links: JSON.parse(localStorage.getItem('w_links') || '[]'), // {from, to, type, strength}
  questions: JSON.parse(localStorage.getItem('w_questions') || '[]'),
  scenarios: JSON.parse(localStorage.getItem('w_scenarios') || '[]'),
  agents: JSON.parse(localStorage.getItem('w_agents') || '[]'),
  api: JSON.parse(localStorage.getItem('w_api') || '{}'),
  selectedSuggestion: null,
};
function persist() {
  localStorage.setItem('w_notes', JSON.stringify(state.notes));
  localStorage.setItem('w_drafts', JSON.stringify(state.drafts));
  localStorage.setItem('w_links', JSON.stringify(state.links));
  localStorage.setItem('w_questions', JSON.stringify(state.questions));
  localStorage.setItem('w_scenarios', JSON.stringify(state.scenarios));
  localStorage.setItem('w_agents', JSON.stringify(state.agents));
  localStorage.setItem('w_api', JSON.stringify(state.api));
}
function uid() { return crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()); }
function nowISO() { return new Date().toISOString(); }
function tokenizeTags(s) { return (s||'').split(',').map(t=>t.trim()).filter(Boolean); }
function words(s){return (s||'').trim().split(/\s+/).filter(Boolean).length;}
function clamp(x,min,max){return Math.max(min,Math.min(max,x));}
/* ------------------------------
   Router
--------------------------------*/
const tabs = document.querySelectorAll('.tab');
const views = {
  '#/notetaker': document.getElementById('view-notetaker'),
  '#/forecast': document.getElementById('view-forecast'),
  '#/graph': document.getElementById('view-graph'),
  '#/scenarios': document.getElementById('view-scenarios'),
  '#/agents': document.getElementById('view-agents'),
};
function setActiveTab(hash) {
  tabs.forEach(t => t.classList.remove('tab-active'));
  document.querySelectorAll(`.tab[data-tab="${hash}"]`).forEach(t => t.classList.add('tab-active'));
}
function showView(hash) {
  Object.values(views).forEach(v => v.classList.add('hidden'));
  (views[hash] || views['#/notetaker']).classList.remove('hidden');
  setActiveTab(hash);
  location.hash = hash;
  if (hash === '#/graph') renderGraph();
}
tabs.forEach(t => t.addEventListener('click', () => showView(t.dataset.tab)));
window.addEventListener('hashchange', () => showView(location.hash));
showView(location.hash || '#/notetaker');

/* ------------------------------
   Notetaker
--------------------------------*/
const els = {
  zid: document.getElementById('note-zid'),
  title: document.getElementById('note-title'),
  content: document.getElementById('note-content'),
  tags: document.getElementById('note-tags'),
  source: document.getElementById('note-source'),
  notesList: document.getElementById('notes-list'),
  searchNotes: document.getElementById('search-notes'),
  suggestBtn: document.getElementById('btn-generate-suggestions'),
  suggestions: document.getElementById('agent-suggestions'),
  newFromSuggestion: document.getElementById('btn-new-from-suggestion'),
};
function clearEditor(){
  els.zid.value = ''; els.title.value=''; els.content.value=''; els.tags.value=''; els.source.value='';
}
function renderNotes() {
  const q = (els.searchNotes.value || '').toLowerCase();
  const items = state.notes.filter(n => {
    const hay = [n.title, (n.tags||[]).join(','), n.content].join(' ').toLowerCase();
    return hay.includes(q);
  }).sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  els.notesList.innerHTML = items.map(n => `
    <article class="border rounded-2xl p-3 bg-white">
      <div class="flex items-center justify-between">
        <h4 class="font-semibold">${escapeHTML(n.title)}</h4>
        <div class="text-xs text-slate-500">${new Date(n.created_at).toLocaleString()}</div>
      </div>
      <div class="text-xs text-slate-600 mt-1">ID: ${escapeHTML(n.zid || '')}</div>
      <p class="mt-2 text-sm">${escapeHTML(n.content).slice(0,220)}${n.content.length>220?'â€¦':''}</p>
      <div class="mt-2 flex flex-wrap gap-1">${(n.tags||[]).map(t=>`<span class="pill">${escapeHTML(t)}</span>`).join('')}</div>
      <div class="mt-2 text-xs text-slate-500">${n.source ? 'Source: '+escapeHTML(n.source):''}</div>
      <div class="mt-3 flex items-center gap-2">
        <button class="btn bg-white" onclick="editNote('${n.id}')">Edit</button>
        <button class="btn bg-white" onclick="linkTo('${n.id}')">Linkâ€¦</button>
        <button class="btn bg-white" onclick="delNote('${n.id}')">Delete</button>
      </div>
    </article>
  `).join('') || `<div class="text-sm text-slate-500">No notes yet.</div>`;
  refreshTagFilter();
}
function escapeHTML(s){return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function editNote(id){
  const n = state.notes.find(x=>x.id===id); if(!n) return;
  els.zid.value = n.zid || ''; els.title.value = n.title; els.content.value = n.content; els.tags.value = (n.tags||[]).join(', '); els.source.value = n.source||'';
  window.scrollTo({top:0, behavior:'smooth'});
}
function delNote(id){
  state.notes = state.notes.filter(n=>n.id!==id);
  state.links = state.links.filter(l=> l.from!==id && l.to!==id);
  persist(); renderNotes(); if (cy) renderGraph();
}
function linkTo(id){
  const others = state.notes.filter(n=>n.id!==id);
  const choice = prompt('Enter target note ID to link to (zettelkasten id or note title).');
  if(!choice) return;
  let target = others.find(n=> (n.zid||'').toLowerCase()===choice.toLowerCase()) || others.find(n=> n.title.toLowerCase()===choice.toLowerCase());
  if(!target){ alert('No match found.'); return; }
  state.links.push({id: uid(), from:id, to:target.id, type:'related', strength:1.0, created_at: nowISO()});
  persist(); if (cy) renderGraph();
}
document.getElementById('btn-save-draft').addEventListener('click', () => {
  const d = {
    id: uid(),
    zid: els.zid.value.trim(),
    title: els.title.value.trim(),
    content: els.content.value.trim(),
    tags: tokenizeTags(els.tags.value),
    source: els.source.value.trim(),
    created_at: nowISO(),
  };
  if (!d.title) return alert('Title required.');
  state.drafts.push(d); persist(); alert('Draft saved. You can continue editing and publish later.')
});
document.getElementById('btn-publish-note').addEventListener('click', () => {
  const note = {
    id: uid(),
    zid: els.zid.value.trim(),
    title: els.title.value.trim(),
    content: els.content.value.trim(),
    tags: tokenizeTags(els.tags.value),
    source: els.source.value.trim(),
    created_at: nowISO(),
    word_count: words(els.content.value),
  };
  if (!note.title) return alert('Title required.');
  if (note.word_count > 500) return alert('Please keep to ~â‰¤500 words.');
  state.notes.push(note); persist(); renderNotes(); if (cy) renderGraph();
  // auto-run default agents (interconnectedness + blind spot)
  runAgents([ 'interconnectedness', 'blind_spot' ], note);
  // keep current text (per user's earlier request), don't clear notetaker
  alert('Note published. Agent suggestions incoming (offline).');
});
els.searchNotes.addEventListener('input', renderNotes);

/* ------------------------------
   Agent Suggestions (offline mode, with optional LLM)
--------------------------------*/
const defaultAgents = [
  { id:'interconnectedness', name:'Interconnectedness', auto:true, system:`Identify related notes and causal/thematic links.` },
  { id:'historian', name:'Historian', auto:false, system:`Provide 2â€“3 historical analogs and lessons.` },
  { id:'blind_spot', name:'Blind Spot', auto:true, system:`Challenge assumptions with alt perspectives and indicators.` },
  { id:'economist', name:'Economist', auto:false, system:`Offer macro framing and monitoring data to track.` },
];
if (state.agents.length===0){ state.agents = defaultAgents; persist(); }
function renderAgentRoster(){
  const host = document.getElementById('agent-roster');
  host.innerHTML = '';
  state.agents.forEach(a => {
    const row = document.createElement('div');
    row.className = 'border rounded-xl p-3 bg-white';
    row.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-medium">${escapeHTML(a.name)}</div>
        <label class="text-sm flex items-center gap-2"><input type="checkbox" ${a.auto?'checked':''} data-auto="${a.id}"/> Auto-run</label>
      </div>
      <div class="text-xs text-slate-600 mt-1">ID: ${escapeHTML(a.id)}</div>
      <textarea class="w-full border rounded-xl px-3 py-2 mt-2 text-sm" rows="3" data-system="${a.id}">${escapeHTML(a.system||'')}</textarea>
      <div class="mt-2 flex gap-2">
        <button class="btn bg-white" data-save="${a.id}">Save</button>
        <button class="btn bg-white" data-del="${a.id}">Delete</button>
      </div>
    `;
    host.appendChild(row);
  });
  host.querySelectorAll('[data-auto]').forEach(ch => ch.addEventListener('change', e => {
    const id = e.target.getAttribute('data-auto');
    const ag = state.agents.find(x=>x.id===id); if (ag){ ag.auto = e.target.checked; persist(); }
  }));
  host.querySelectorAll('[data-system]').forEach(t => t.addEventListener('change', e => {
    const id = e.target.getAttribute('data-system');
    const ag = state.agents.find(x=>x.id===id); if (ag){ ag.system = e.target.value; persist(); }
  }));
  host.querySelectorAll('[data-save]').forEach(b => b.addEventListener('click', ()=>alert('Saved.')));
  host.querySelectorAll('[data-del]').forEach(b => b.addEventListener('click', e => {
    const id = e.target.getAttribute('data-del'); state.agents = state.agents.filter(x=>x.id!==id); persist(); renderAgentRoster();
  }));
}
document.getElementById('btn-add-agent').addEventListener('click', () => {
  const name = prompt('Agent name?'); if(!name) return;
  state.agents.push({ id: name.toLowerCase().replace(/\s+/g,'_')+'_'+Math.floor(Math.random()*999), name, auto:false, system:'Custom agent prompt here.' });
  persist(); renderAgentRoster();
});
function renderAgentSettings() {
  document.getElementById('api-base').value = state.api.base || '';
  document.getElementById('api-key').value = state.api.key || '';
  document.getElementById('api-model').value = state.api.model || '';
  document.getElementById('api-status').textContent = state.api.key ? 'Online mode enabled (client-side).' : 'Offline mode (mock heuristics).';
}
document.getElementById('btn-save-api').addEventListener('click', () => {
  state.api = {
    base: document.getElementById('api-base').value.trim(),
    key: document.getElementById('api-key').value.trim(),
    model: document.getElementById('api-model').value.trim(),
  };
  persist(); renderAgentSettings();
  alert('Saved. Note: client-side keys are visible in the browser.');
});

async function llmCall(messages) {
  // Only use if user provided base+key+model. Follows OpenAI-compatible schema.
  if (!(state.api.base && state.api.key && state.api.model)) return null;
  try {
    const res = await fetch(state.api.base + '/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + state.api.key,
      },
      body: JSON.stringify({ model: state.api.model, messages, temperature: 0.3 })
    });
    const data = await res.json();
    const txt = data?.choices?.[0]?.message?.content || null;
    return txt;
  } catch (e) {
    console.warn('LLM call failed:', e);
    return null;
  }
}

// offline heuristics
function offlineSuggest(agentId, note) {
  if (agentId === 'interconnectedness') {
    // link by tag overlap
    const related = state.notes
      .filter(n => n.id !== note.id)
      .map(n => ({ n, overlap: (n.tags||[]).filter(t => (note.tags||[]).includes(t)).length }))
      .filter(x => x.overlap>0)
      .sort((a,b)=>b.overlap - a.overlap)
      .slice(0,3);
    return {
      title: 'Suggested Links',
      suggestions: related.map(x => ({
        kind: 'link',
        toId: x.n.id,
        toTitle: x.n.title,
        reason: `Shares ${x.overlap} tag(s): ${x.n.tags.filter(t=>note.tags.includes(t)).join(', ')}`
      }))
    };
  }
  if (agentId === 'historian') {
    return {
      title: 'Historical Parallels',
      suggestions: [
        { kind: 'note', title: `Analog: ${note.title} vs. Dot-com Era`, content: `Similarity: risk appetite + credit growth. Difference: sector concentration. Lessons: watch leverage + funding fragility.` },
        { kind: 'note', title: `Analog: ${note.title} vs. S&L Crisis`, content: `Similarity: maturity mismatch. Difference: rate regime + regulation. Monitor: deposit flows, duration risk.` },
      ]
    };
  }
  if (agentId === 'blind_spot') {
    return {
      title: 'Blind Spots',
      suggestions: [
        { kind: 'note', title: 'Pension/Insurance Angle', content: 'How do ALM constraints amplify/mitigate this? Indicators: solvency ratios, reinvestment risk.' },
        { kind: 'note', title: 'EM Spillovers', content: 'Could dollar strength or commodity shocks transmit? Indicators: FX reserves, basis, CDS.' }
      ]
    };
  }
  if (agentId === 'economist') {
    return {
      title: 'Macro Frame',
      suggestions: [
        { kind: 'note', title: 'Macro Drivers', content: 'Output gap, credit impulse, policy stance, term premium. Track: labor, inflation breadth, financial conditions.' }
      ]
    };
  }
  return { title: 'No suggestions', suggestions: [] };
}

async function runAgents(agentIds, note) {
  els.suggestions.innerHTML = '<div class="text-sm text-slate-500">Generatingâ€¦</div>';
  const out = [];
  for (const id of agentIds) {
    const agent = state.agents.find(a => a.id===id);
    if (!agent) continue;
    // Try LLM call if configured, else offline
    let block = null;
    const prompt = `${agent.system}\n\nUser note:\nTitle: ${note.title}\nTags: ${(note.tags||[]).join(', ')}\nContent: ${note.content}`;
    const llm = await llmCall([{role:'system', content: agent.system}, {role:'user', content: prompt}]);
    if (llm) {
      block = { title: agent.name, llm: true, raw: llm, suggestions: [] };
    } else {
      block = offlineSuggest(id, note);
    }
    out.push({ agent: agent.name, block });
  }
  // Render
  els.suggestions.innerHTML = out.map((o, idx) => {
    const s = o.block;
    if (s.llm) {
      return `<div class="border rounded-xl p-3 bg-white">
        <div class="font-medium mb-1">${escapeHTML(o.agent)}</div>
        <pre class="text-sm whitespace-pre-wrap">${escapeHTML(s.raw)}</pre>
        <div class="mt-2 flex gap-2">
          <button class="btn bg-white" data-accept-llm="${idx}">Accept as Note</button>
        </div>
      </div>`;
    }
    return `<div class="border rounded-xl p-3 bg-white">
      <div class="font-medium">${escapeHTML(o.agent)} â€” ${escapeHTML(s.title)}</div>
      <div class="mt-2 space-y-2">
        ${s.suggestions.map((g,i) => g.kind==='link'
          ? `<div class="text-sm">
               <div>ðŸ”— Link to: <strong>${escapeHTML(g.toTitle)}</strong></div>
               <div class="text-xs text-slate-600">${escapeHTML(g.reason)}</div>
               <button class="btn bg-white mt-1" data-link="${idx}:${i}">Add Link</button>
             </div>`
          : `<div class="text-sm">
               <div class="font-medium">${escapeHTML(g.title)}</div>
               <div class="text-xs text-slate-700">${escapeHTML(g.content)}</div>
               <button class="btn bg-white mt-1" data-suggest="${idx}:${i}">Add as Note</button>
             </div>`
        ).join('')}
      </div>
    </div>`;
  }).join('');
  // wire buttons
  els.suggestions.querySelectorAll('[data-link]').forEach(b => b.addEventListener('click', () => {
    const [bi,si] = b.getAttribute('data-link').split(':').map(Number);
    const block = out[bi].block;
    const sug = block.suggestions[si];
    if (!sug) return;
    state.links.push({ id: uid(), from: state.notes[state.notes.length-1].id, to: sug.toId, type:'related', strength:1.0, created_at: nowISO() });
    persist(); if (cy) renderGraph(); alert('Link added.');
  }));
  els.suggestions.querySelectorAll('[data-suggest]').forEach(b => b.addEventListener('click', () => {
    const [bi,si] = b.getAttribute('data-suggest').split(':').map(Number);
    const block = out[bi].block;
    const sug = block.suggestions[si];
    if (!sug) return;
    state.selectedSuggestion = { title: sug.title, content: sug.content };
    alert('Suggestion selected. Click "New from Selected Suggestion" to create a note draft.');
  }));
  els.suggestions.querySelectorAll('[data-accept-llm]').forEach(b => b.addEventListener('click', () => {
    const i = Number(b.getAttribute('data-accept-llm'));
    const block = out[i].block;
    state.selectedSuggestion = { title: 'Agent Draft', content: block.raw.slice(0, 1000) };
    alert('LLM draft captured. Click "New from Selected Suggestion".');
  }));
}
els.suggestBtn.addEventListener('click', () => {
  const note = {
    id: uid(),
    title: els.title.value.trim() || '(untitled)',
    content: els.content.value.trim(),
    tags: tokenizeTags(els.tags.value),
  };
  runAgents(Array.from(document.querySelectorAll('.agent-toggle:checked')).map(x=>x.value), note);
});
els.newFromSuggestion.addEventListener('click', () => {
  if (!state.selectedSuggestion) return alert('No suggestion selected.');
  els.title.value = state.selectedSuggestion.title;
  els.content.value = state.selectedSuggestion.content;
  state.selectedSuggestion = null;
});

/* ------------------------------
   Forecast tournament
--------------------------------*/
function renderQuestions(){
  const host = document.getElementById('forecast-questions');
  host.innerHTML = '';
  state.questions.forEach((q, idx) => {
    const opts = q.options || [];
    const user = q.user || {}; // option->prob
    const total = Object.values(user).reduce((a,b)=>a+(+b||0),0);
    const valid = Math.round(total)===100;
    const resolved = !!q.correct;
    const score = resolved ? brierScore(user, q.correct) : null;
    const box = document.createElement('div');
    box.className = 'border rounded-2xl p-3 bg-white';
    box.innerHTML = `
      <div class="flex justify-between items-start gap-3">
        <div>
          <div class="font-medium">Q${idx+1}. ${escapeHTML(q.text)}</div>
          <div class="text-xs text-slate-500 mt-1">Deadline: ${q.deadline ? new Date(q.deadline).toLocaleDateString() : 'â€”'}</div>
          ${q.context ? `<div class="text-sm mt-2 text-slate-700">${escapeHTML(q.context)}</div>` : ''}
        </div>
        <div class="flex gap-2">
          <button class="btn bg-white" data-delq="${q.id}">Delete</button>
        </div>
      </div>
      <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
        ${opts.map(o => `
          <div class="border rounded-xl p-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-medium">${escapeHTML(o)}</div>
              <input type="number" min="0" max="100" step="1" class="w-20 border rounded-xl px-2 py-1 text-sm" data-prob="${q.id}:${o}" value="${user[o]??0}"/>
            </div>
          </div>
        `).join('')}
      </div>
      <div class="mt-2 text-xs ${valid?'text-green-600':'text-slate-500'}">Total: ${total}% ${valid?'(valid)':'(must sum to 100%)'}</div>
      <div class="mt-2 flex gap-2">
        <button class="btn bg-white" data-saveq="${q.id}">Save</button>
        <button class="btn bg-white" data-resolve="${q.id}">Resolve</button>
        ${resolved? `<span class="pill">Resolved: ${escapeHTML(q.correct)}</span><span class="pill">Brier: ${score.toFixed(3)}</span>`:''}
      </div>
    `;
    host.appendChild(box);
  });
  host.querySelectorAll('[data-delq]').forEach(b => b.addEventListener('click', e => {
    const id = e.target.getAttribute('data-delq'); state.questions = state.questions.filter(x=>x.id!==id); persist(); renderQuestions();
  }));
  host.querySelectorAll('[data-prob]').forEach(inp => inp.addEventListener('input', e => {
    const [id, opt] = e.target.getAttribute('data-prob').split(':');
    const q = state.questions.find(x=>x.id===id); if (!q) return;
    q.user = q.user || {}; q.user[opt] = clamp(parseInt(e.target.value||0,10), 0, 100);
    persist(); renderQuestions();
  }));
  host.querySelectorAll('[data-saveq]').forEach(b => b.addEventListener('click', () => alert('Saved.')));
  host.querySelectorAll('[data-resolve]').forEach(b => b.addEventListener('click', () => {
    const id = b.getAttribute('data-resolve'); const q = state.questions.find(x=>x.id===id); if (!q) return;
    const correct = prompt('Enter correct option EXACTLY as listed.'); if(!correct) return;
    if (!(q.options||[]).includes(correct)) return alert('Option not found.');
    q.correct = correct; persist(); renderQuestions();
  }));
}
function brierScore(pred, correct) {
  const opts = Object.keys(pred);
  if (opts.length===0) return 0;
  let s = 0;
  opts.forEach(o => {
    const p = (pred[o]||0)/100;
    const y = o===correct ? 1 : 0;
    s += (p - y) * (p - y);
  });
  return s / opts.length;
}
document.getElementById('btn-add-question').addEventListener('click', () => {
  const text = prompt('Question text?'); if(!text) return;
  const opts = prompt('Comma-separated options? (e.g., Yes, No)'); if(!opts) return;
  state.questions.push({ id: uid(), text, options: opts.split(',').map(s=>s.trim()).filter(Boolean), context: '', deadline: null, user: {} });
  persist(); renderQuestions();
});

/* ------------------------------
   Graph (Cytoscape)
--------------------------------*/
let cy = null;
function refreshTagFilter(){
  const sel = document.getElementById('graph-filter-tag');
  const tags = new Set(state.notes.flatMap(n=>n.tags||[]));
  const prev = sel.value;
  sel.innerHTML = '<option value="">Filter by tagâ€¦</option>' + Array.from(tags).sort().map(t => `<option value="${escapeHTML(t)}">${escapeHTML(t)}</option>`).join('');
  sel.value = prev || '';
}
document.getElementById('graph-filter-tag').addEventListener('change', renderGraph);
function renderGraph(){
  const filterTag = document.getElementById('graph-filter-tag').value;
  const nodes = state.notes
    .filter(n => !filterTag || (n.tags||[]).includes(filterTag))
    .map(n => ({ data: { id: n.id, label: n.title, tags: (n.tags||[]).join(', ') } }));
  const allowed = new Set(nodes.map(n => n.data.id));
  const edges = state.links
    .filter(l => allowed.has(l.from) && allowed.has(l.to))
    .map(l => ({ data: { id: l.id, source: l.from, target: l.to, label: l.type } }));
  const container = document.getElementById('cy');
  if (!cy) {
    cy = cytoscape({
      container,
      elements: { nodes, edges },
      style: [
        { selector: 'node', style: { 'label': 'data(label)', 'text-wrap':'wrap', 'text-max-width': 160, 'font-size': 10, 'background-color': '#0ea5e9', 'color': '#0f172a'} },
        { selector: 'edge', style: { 'width': 2, 'line-color': '#94a3b8', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#94a3b8', 'curve-style': 'bezier', 'label':'data(label)', 'font-size': 8, 'text-background-opacity': 1, 'text-background-color': '#fff'} },
        { selector: ':selected', style: { 'border-width': 3, 'border-color': '#111827' } }
      ],
      layout: { name: 'cose', animate: true }
    });
    cy.on('tap', 'node', evt => {
      const id = evt.target.id();
      const n = state.notes.find(x=>x.id===id);
      if (n) alert(`${n.title}\n\n${n.content.slice(0,600)}`);
    });
  } else {
    cy.json({ elements: { nodes, edges } });
    cy.layout({ name:'cose', animate: true }).run();
  }
  document.getElementById('graph-insights').innerHTML =
    `<div class="text-sm text-slate-600">Nodes: ${nodes.length} â€¢ Edges: ${edges.length}</div>`;
}
document.getElementById('btn-generate-insights').addEventListener('click', () => {
  const clusters = clusterByTag();
  const topTags = Object.entries(clusters).sort((a,b)=>b[1].length - a[1].length).slice(0,5).map(([t,arr])=> `${t} (${arr.length})`).join(', ') || 'â€”';
  document.getElementById('graph-insights').innerHTML =
    `<div class="text-sm">Top tag clusters: ${escapeHTML(topTags)}</div>`;
});
function clusterByTag(){
  const map = {};
  state.notes.forEach(n => (n.tags||[]).forEach(t => { map[t] = map[t] || []; map[t].push(n.id); }));
  return map;
}

/* ------------------------------
   Scenarios
--------------------------------*/
function renderScenarios(){
  const host = document.getElementById('scenario-list');
  host.innerHTML = '';
  state.scenarios.forEach(s => {
    const row = document.createElement('div');
    row.className = 'border rounded-2xl p-3 bg-white';
    row.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-medium">${escapeHTML(s.title)}</div>
        <div class="text-xs text-slate-500">${escapeHTML(s.timeframe||'6â€“12 months')}</div>
      </div>
      <p class="text-sm mt-2">${escapeHTML(s.description)}</p>
      <div class="mt-2 flex flex-wrap gap-2 items-center">
        <span class="pill">P=${(s.prob||0).toFixed(2)}</span>
        <button class="btn bg-white" data-edits="${s.id}">Edit</button>
        <button class="btn bg-white" data-dels="${s.id}">Delete</button>
      </div>
    `;
    host.appendChild(row);
  });
  host.querySelectorAll('[data-dels]').forEach(b => b.addEventListener('click', e => {
    const id = e.target.getAttribute('data-dels'); state.scenarios = state.scenarios.filter(x=>x.id!==id); persist(); renderScenarios();
  }));
  host.querySelectorAll('[data-edits]').forEach(b => b.addEventListener('click', e => {
    const id = e.target.getAttribute('data-edits'); const s = state.scenarios.find(x=>x.id===id); if(!s) return;
    const title = prompt('Title', s.title); if(!title) return;
    const desc = prompt('Description', s.description)||'';
    const prob = parseFloat(prompt('Probability (0â€“1)', s.prob||0.2))||0;
    const tf = prompt('Timeframe', s.timeframe||'6â€“12 months')||'6â€“12 months';
    Object.assign(s, { title, description: desc, prob, timeframe: tf });
    persist(); renderScenarios();
  }));
}
document.getElementById('btn-add-scenario').addEventListener('click', () => {
  const title = prompt('Scenario title?'); if(!title) return;
  const description = prompt('Description?')||'';
  const prob = parseFloat(prompt('Probability (0â€“1)?', '0.2'))||0;
  const timeframe = prompt('Timeframe?', '6â€“12 months')||'6â€“12 months';
  state.scenarios.push({ id: uid(), title, description, prob, timeframe, created_at: nowISO() });
  persist(); renderScenarios();
});

/* ------------------------------
   Export/Import/Reset
--------------------------------*/
document.getElementById('btn-export').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'willow_data.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
});
document.getElementById('file-import').addEventListener('change', async (e) => {
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  try {
    const data = JSON.parse(text);
    ['notes','drafts','links','questions','scenarios','agents','api'].forEach(k => {
      if (k in data) state[k] = data[k];
    });
    persist(); renderAll();
    alert('Imported.');
  } catch { alert('Invalid JSON.'); }
});
document.getElementById('btn-reset').addEventListener('click', () => {
  if (!confirm('Reset all local data?')) return;
  Object.keys(state).forEach(k => {
    if (Array.isArray(state[k])) state[k] = [];
    else if (typeof state[k]==='object') state[k] = {};
  });
  persist(); renderAll();
});

/* ------------------------------
   Boot
--------------------------------*/
function renderAll(){
  renderNotes(); renderQuestions(); renderAgentRoster(); renderAgentSettings(); refreshTagFilter(); renderScenarios();
  if (views['#/graph'] && !views['#/graph'].classList.contains('hidden')) renderGraph();
}
renderAll();
</script>
</body>
</html>
