<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notetaker with [[link]] Suggestions</title>

<style>
  :root{
    --bg:#ffffff; --panel:#f5f7fb; --text:#0e1116; --muted:#4b5563; --border:#e5e7eb; --primary:#2563eb;
  }
  .dark{
    --bg:#0b0f15; --panel:#121823; --text:#e6e9ef; --muted:#a3aab7; --border:#1f2633; --primary:#60a5fa;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    transition: background .2s ease, color .2s ease;
  }
  .app{
    max-width:1100px; margin:24px auto; padding:0 16px; display:grid; grid-template-columns: 340px 1fr; gap:16px;
  }
  .card{
    background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px;
  }
  h1{margin:0 0 10px; font-size:20px}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input[type="text"]{
    width:100%; padding:.6rem .75rem; border:1px solid var(--border); background:var(--bg); color:var(--text);
    border-radius:10px; outline:none;
  }
  input[type="text"]:focus{border-color:var(--primary)}
  textarea{
    width:100%; min-height:330px; resize:vertical; padding:.75rem .85rem; border-radius:12px;
    border:1px solid var(--border); background:var(--bg); color:var(--text); outline:none; line-height:1.4;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  }
  textarea:focus{border-color:var(--primary)}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{
    border:1px solid var(--border); background:var(--panel); color:var(--text); padding:.55rem .9rem;
    border-radius:999px; cursor:pointer;
  }
  .btn:hover{border-color:var(--primary)}
  .btn.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
  .muted{color:var(--muted); font-size:12px}
  .list{display:flex; flex-direction:column; gap:8px; max-height:520px; overflow:auto}
  .noteItem{
    border:1px solid var(--border); border-radius:12px; padding:10px; background:var(--bg); cursor:pointer;
  }
  .noteItem:hover{border-color:var(--primary)}
  .noteTitle{font-weight:600}
  .noteMeta{font-size:11px; color:var(--muted)}
  .tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
  .tag{
    font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); color:var(--muted);
  }

  /* Suggestions dropdown */
  .suggestions{
    position:absolute; display:none; background:var(--panel); border:1px solid var(--border);
    border-radius:10px; box-shadow:0 8px 18px rgba(0,0,0,.18); max-height:220px; overflow:auto; z-index:1000;
    min-width:280px;
  }
  .sug-item{
    padding:.45rem .75rem; cursor:pointer; display:flex; justify-content:space-between; gap:12px;
  }
  .sug-item:hover, .sug-item.active{ background:var(--primary); color:#fff }
  .sug-count{ font-size:12px; opacity:.8 }

  /* Floating theme toggle */
  #themeToggle{
    position:fixed; right:12px; bottom:12px; z-index:2000;
  }
</style>
</head>
<body>
  <button id="themeToggle" class="btn" aria-label="Toggle theme">ðŸŒ™</button>

  <div class="app">
    <!-- Sidebar: notes & popular links -->
    <div class="card">
      <h1>Notes</h1>
      <div class="row" style="margin-bottom:8px">
        <button id="newNote" class="btn">New</button>
        <button id="deleteNote" class="btn">Delete</button>
        <span class="muted">Click a note to load it.</span>
      </div>
      <div id="notesList" class="list" aria-label="Saved notes"></div>

      <h1 style="margin-top:18px">Popular Links</h1>
      <div id="popularLinks" class="tags"></div>
    </div>

    <!-- Editor -->
    <div class="card" style="position:relative">
      <h1>Editor</h1>
      <label for="title">Title</label>
      <input id="title" type="text" placeholder="Note titleâ€¦" />
      <div class="row" style="margin:10px 0 6px">
        <div class="muted">Tip: type <strong>[[</strong> to link to other pages.</div>
        <div style="flex:1"></div>
        <button id="save" class="btn primary">Save</button>
      </div>
      <label for="content">Content</label>
      <textarea id="content" placeholder="Write your noteâ€¦ Use [[Link Names]] to create or reference pages."></textarea>

      <!-- Suggestions dropdown -->
      <div id="suggestions" class="suggestions" role="listbox" aria-label="Link suggestions"></div>
    </div>
  </div>

<script>
/* =======================
   THEME (dark/light)
======================= */
(function initTheme(){
  const root=document.documentElement;
  const saved=localStorage.getItem('theme');
  const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme=saved || (prefersDark?'dark':'light');
  root.classList.toggle('dark', theme==='dark');
  updateToggleIcon(theme);
})();
document.getElementById('themeToggle').addEventListener('click',()=>{
  const root=document.documentElement;
  const isDark=root.classList.toggle('dark');
  localStorage.setItem('theme', isDark?'dark':'light');
  updateToggleIcon(isDark?'dark':'light');
});
function updateToggleIcon(theme){
  const btn=document.getElementById('themeToggle');
  btn.textContent = theme==='dark' ? 'ðŸŒž' : 'ðŸŒ™';
  btn.title = theme==='dark' ? 'Switch to light mode' : 'Switch to dark mode';
}

/* =======================
   STORAGE KEYS
======================= */
const KEY_NOTES = 'notes.v1';
const KEY_LINK_COUNTS = 'linkCounts.v1';

/* =======================
   STATE
======================= */
let notes = load(KEY_NOTES, []);
let linkCounts = load(KEY_LINK_COUNTS, {}); // { "Link Name": count }
let activeNoteId = null;

/* =======================
   HELPERS
======================= */
function load(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; }
}
function save(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}
function uid(){ return 'n_'+Math.random().toString(36).slice(2,9); }
function fmtDate(ts){ const d=new Date(ts); return d.toLocaleString(); }

function extractLinks(text){
  const out=[]; if(!text) return out;
  const re=/\[\[([^\[\]]+)\]\]/g; let m;
  while((m=re.exec(text))){ const name=m[1].trim(); if(name) out.push(name); }
  return out;
}

function recountLinksFromAllNotes(){
  const counts={};
  for(const n of notes){
    const unique = new Set(extractLinks(n.content));
    for(const name of unique){
      counts[name] = (counts[name]||0)+1;
    }
  }
  linkCounts = counts;
  save(KEY_LINK_COUNTS, linkCounts);
}

/* =======================
   RENDER
======================= */
const notesListEl = document.getElementById('notesList');
const popularLinksEl = document.getElementById('popularLinks');
const titleEl = document.getElementById('title');
const contentEl = document.getElementById('content');
const suggestionsEl = document.getElementById('suggestions');

function renderNotesList(){
  notesListEl.innerHTML='';
  const sorted=[...notes].sort((a,b)=>b.updated-a.updated);
  for(const n of sorted){
    const div=document.createElement('div');
    div.className='noteItem';
    div.tabIndex=0;
    div.innerHTML=`
      <div class="noteTitle">${escapeHtml(n.title || '(Untitled)')}</div>
      <div class="noteMeta">Updated ${fmtDate(n.updated)}</div>
    `;
    div.onclick=()=>loadNote(n.id);
    div.onkeydown=(e)=>{ if(e.key==='Enter') loadNote(n.id); };
    notesListEl.appendChild(div);
  }
}

function renderPopularLinks(){
  popularLinksEl.innerHTML='';
  const entries = Object.entries(linkCounts).sort((a,b)=>b[1]-a[1]).slice(0,30);
  for(const [name,count] of entries){
    const span=document.createElement('span');
    span.className='tag';
    span.textContent = `${name} (${count})`;
    popularLinksEl.appendChild(span);
  }
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* =======================
   CRUD
======================= */
function newNote(){
  const n={ id:uid(), title:'', content:'', created:Date.now(), updated:Date.now() };
  notes.unshift(n);
  activeNoteId=n.id;
  save(KEY_NOTES, notes);
  titleEl.value=''; contentEl.value='';
  renderNotesList(); renderPopularLinks();
  titleEl.focus();
}

function loadNote(id){
  const n = notes.find(x=>x.id===id);
  if(!n) return;
  activeNoteId=id;
  titleEl.value=n.title||'';
  contentEl.value=n.content||'';
  hideSuggestions();
}

function deleteNote(){
  if(!activeNoteId) return;
  notes = notes.filter(n=>n.id!==activeNoteId);
  activeNoteId=null;
  save(KEY_NOTES, notes);
  recountLinksFromAllNotes();
  renderNotesList(); renderPopularLinks();
  titleEl.value=''; contentEl.value='';
}

function saveNote(){
  if(!activeNoteId) newNote(); // ensure there is an active note
  const idx = notes.findIndex(n=>n.id===activeNoteId);
  const isNew = idx===-1;
  const now = Date.now();
  const payload = {
    id: activeNoteId,
    title: titleEl.value.trim(),
    content: contentEl.value,
    created: isNew ? now : notes[idx].created,
    updated: now
  };
  if(isNew) notes.unshift(payload); else notes[idx]=payload;

  // Update link popularity
  recountLinksFromAllNotes(); // recompute from all notes for accuracy

  save(KEY_NOTES, notes);
  renderNotesList(); renderPopularLinks();
}

/* =======================
   SUGGESTIONS: [[wiki]] autocomplete
======================= */
let activeIndex = -1; // keyboard highlight index
let currentMatches = [];

function showSuggestions(results){
  if(!results.length){ hideSuggestions(); return; }
  suggestionsEl.innerHTML='';
  results.forEach((item,i)=>{
    const div=document.createElement('div');
    div.className='sug-item';
    div.setAttribute('role','option');
    if(i===activeIndex) div.classList.add('active');
    div.innerHTML = `<span>${escapeHtml(item.name)}</span><span class="sug-count">${item.count}</span>`;
    div.onclick=()=>insertSuggestion(item.name);
    suggestionsEl.appendChild(div);
  });
  // Position: under the textarea (simple & robust)
  const rect=contentEl.getBoundingClientRect();
  suggestionsEl.style.left = rect.left + window.scrollX + 'px';
  suggestionsEl.style.top  = (rect.bottom + window.scrollY + 6) + 'px';
  suggestionsEl.style.width = rect.width + 'px';
  suggestionsEl.style.display='block';
}

function hideSuggestions(){
  suggestionsEl.style.display='none';
  activeIndex=-1;
  currentMatches=[];
}

function findTrigger(){
  // Text up to caret; look for `[[...` not yet closed
  const pos = contentEl.selectionStart;
  const text = contentEl.value.substring(0,pos);
  const m = text.match(/\[\[([^\]]*)$/);
  if(!m) return null;
  return m[1]; // the typed portion after [[
}

function computeMatches(queryRaw){
  const q = (queryRaw||'').toLowerCase();
  const entries = Object.entries(linkCounts);
  const filtered = entries
    .filter(([name]) => name.toLowerCase().includes(q))
    .map(([name,count])=>({name, count}))
    .sort((a,b)=> b.count - a.count || a.name.localeCompare(b.name))
    .slice(0,20);
  return filtered;
}

function insertSuggestion(name){
  const pos = contentEl.selectionStart;
  const before = contentEl.value.substring(0,pos);
  const after  = contentEl.value.substring(pos);
  const replaced = before.replace(/\[\[[^\]]*$/, `[[${name}]]`);
  contentEl.value = replaced + after;
  // Move caret to end of inserted ]] pair
  const newPos = replaced.length;
  contentEl.setSelectionRange(newPos,newPos);
  contentEl.focus();
  hideSuggestions();
}

contentEl.addEventListener('input', onTypeOrCursor);
contentEl.addEventListener('keyup', onTypeOrCursor);
contentEl.addEventListener('click', onTypeOrCursor);
contentEl.addEventListener('keydown', (e)=>{
  if(suggestionsEl.style.display==='block'){
    if(e.key==='ArrowDown'){ e.preventDefault(); activeIndex = Math.min(activeIndex+1, currentMatches.length-1); showSuggestions(currentMatches); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); activeIndex = Math.max(activeIndex-1, 0); showSuggestions(currentMatches); }
    else if(e.key==='Enter'){ 
      if(activeIndex>=0){ e.preventDefault(); insertSuggestion(currentMatches[activeIndex].name); }
    } else if(e.key==='Escape'){ hideSuggestions(); }
  }
});

document.addEventListener('click', (e)=>{
  if(!suggestionsEl.contains(e.target) && e.target!==contentEl){ hideSuggestions(); }
});

function onTypeOrCursor(){
  const partial = findTrigger();
  if(partial===null){ hideSuggestions(); return; }
  currentMatches = computeMatches(partial);
  activeIndex = currentMatches.length ? 0 : -1;
  showSuggestions(currentMatches);
}

/* =======================
   INIT + UI HOOKS
======================= */
document.getElementById('newNote').onclick=newNote;
document.getElementById('deleteNote').onclick=deleteNote;
document.getElementById('save').onclick=saveNote;

(function init(){
  // First load: build linkCounts if missing
  if(Object.keys(linkCounts).length===0 && notes.length>0){
    recountLinksFromAllNotes();
  }
  renderNotesList();
  renderPopularLinks();
  // If there are notes, load the newest
  if(notes.length){ loadNote(notes[0].id); }
})();
</script>
</body>
</html>
